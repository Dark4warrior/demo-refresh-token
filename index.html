<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<button onclick="login()">1. Se connecter (Login)</button>
<button onclick="getData()">2. Appeler API (Profil)</button>

<div id="status">Statut : Non connecté</div>

<script>
    let accessToken = null;
    let refreshToken = null;

    async function login() {
        const res = await axios.post('http://localhost:4000/login', { username: 'Elon' });
        accessToken = res.data.accessToken;
        refreshToken = res.data.refreshToken;
        document.getElementById('status').innerText = "Statut : Connecté !";
    }

    axios.interceptors.response.use(
        response => response,
        async (error) => {
            if (error.response.status === 401) {
                console.log("Access Token expiré, tentative de refresh...");
                const res = await axios.post('http://localhost:4000/token', { token: refreshToken });
                accessToken = res.data.accessToken;
                
                error.config.headers['Authorization'] = 'Bearer ' + accessToken;
                return axios(error.config);
            }
            return Promise.reject(error);
        }
    );

    async function getData() {
    try {
        const res = await axios.get('http://localhost:4000/data?t=' + Date.now(), {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        console.log("Réponse serveur :", res.data);
        alert("Données récupérées !");
    } catch (e) {
        console.log("Erreur capturée :", e.response?.status);
    }
}
</script>